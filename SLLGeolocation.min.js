/*
* SLLGeolocation.js - depends on geoPosition.js
* Author: A. Longoria for the Texas State Law Library
* E-mail: alongoria@sll.texas.gov
*/
var SLLGeolocation={Errors:{NO_GEOLOCATION:"Unfortunately, geolocation is not available on your computer, device, or web browser. Please try using a different browser or internet connection.",PERMISSION_DENIED:"Your location could not be determined because you or your browser have denied permission. Please review your browser settings to ensure you are not automatically denying all geolocation requests.",POSITION_UNAVAILABLE:"Your position is currently unavailable. Please try again, or use a different internet connection if this problem persists.",TIMEOUT:"Timeout error. There may have been a temporary glitch. Please try again, or use a different internet connection if this problem persists.",UNKNOWN_ERROR_CODE:"Unknown error code. Please try again, or use a different internet connection if this problem persists.",UNKNOWN_ERROR:"An unknown error has occured. Please try again, or use a different internet connection if this problem persists.",NOT_IN_TEXAS:"It looks like you may not be in Texas at the moment. Due to licensing agreements, we are able to offer online registration only to Texas residents who are physically located in Texas. Determining your physical location from your internet connection is not exact. If you feel this is an error, please contact the library.",DEFAULT:"We were unable to determine your location. Please try again, or use a different internet connection if this problem persists."},geoSuccess:function(c){var a=$("#js-geo-results");a.data("latitude",c.coords.latitude);a.data("longitude",c.coords.longitude);var e=new google.maps.LatLng(c.coords.latitude,c.coords.longitude);var d={location:e};var b=new google.maps.Geocoder();b.geocode(d,function(k,l){if(l==google.maps.GeocoderStatus.OK){if(k[0]){var f=k[0].formatted_address;a.data("geocoded-address",f);var j={zoom:7,mapTypeControl:true,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:false};var h=new google.maps.Map(document.getElementById("js-map-canvas"),j);h.setCenter(new google.maps.LatLng(a.data("latitude"),a.data("longitude")));var g=new google.maps.InfoWindow({content:f});var i=new google.maps.Marker({position:e,map:h,title:"you are here"});google.maps.event.addListener(i,"click",function(){g.open(h,i)});if(SLLGeolocation.isTexas(k[0].address_components)){SLLGeolocation.success(f)}else{SLLGeolocation.geoError(SLLGeolocation.Errors.NOT_IN_TEXAS)}}}else{SLLGeolocation.geoError("Geocoder failed due to: "+l+". Please reload this page and try again. If this problem persists, please contact the library.")}})},geoError:function(e){var a=$("<p />",{text:"Geolocation failed! See the error message below for more details."});var d="";if(typeof(e)==="object"){if("message" in e&&e.message.length){if(e.message.indexOf("This site does not have permission to use the Geolocation API")>-1){d=SLLGeolocation.Errors.PERMISSION_DENIED}else{if(e.message.indexOf("User denied Geolocation")>-1){d=SLLGeolocation.Errors.PERMISSION_DENIED}else{if(e.message.indexOf("User denied geolocation prompt")>-1){d=SLLGeolocation.Errors.PERMISSION_DENIED}else{if(e.message.indexOf("This site doesn't have permission to ask for your location")>-1){d=SLLGeolocation.Errors.PERMISSION_DENIED}else{d=e.message}}}}}else{if("code" in e){if(e.code===e.PERMISSION_DENIED){d=SLLGeolocation.Errors.PERMISSION_DENIED}else{if(e.code===e.POSITION_UNAVAILABLE){d=SLLGeolocation.Errors.POSITION_UNAVAILABLE}else{if(e.code===e.TIMEOUT){d=SLLGeolocation.Errors.TIMEOUT}else{d=SLLGeolocation.Errors.UNKNOWN_ERROR_CODE}}}}else{d=SLLGeolocation.Errors.UNKNOWN_ERROR}}}else{if(typeof(e)==="string"&&e.length){d=e}else{d=SLLGeolocation.Errors.DEFAULT}}var b=$("<p />",{html:d});var c=$("<p />",{html:"If you are physically located in Texas at the moment but are receiving error messages when you try to register, view our troubleshooting page for help. On that page you will find a list of common error messages, what they mean, and how you may resolve the issue."});$myGeoResults=$("#js-geo-results");$myGeoResults.empty().append(a).append(b).append(c)},isTexas:function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b].types;if(d.length&&d[0]==="administrative_area_level_1"){if(a[b].long_name&&a[b].long_name.indexOf("Texas")>-1){return true}else{if(a[b].short_name&&a[b].short_name.indexOf("TX")>-1){return true}}break}}return false},success:function(a){if(a){var b="<p>You're in Texas, yay! See the map below for our best guess of your current location: "+a+".</p>";$("#js-geo-results").empty().html(b)}},init:function(){var a=("#js-geo-results");$("#js-get-location-button").on("click",function(){var b=$("<img />",{src:"/images/ajax-loader.gif",alt:"loading..."});a.empty().append(b);if(geoPosition.init()){geoPosition.getCurrentPosition(SLLGeolocation.geoSuccess,SLLGeolocation.geoError,{enableHighAccuracy:true})}else{SLLGeolocation.geoError(SLLGeolocation.Errors.NO_GEOLOCATION)}})}};